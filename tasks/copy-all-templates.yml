# Dateien die mit nr_ beginnen, l√∂sen keinen Restart aus.

- name: Create root directory
  ansible.builtin.file:
    path: "{{ target | default(root) }}"
    state: directory
    mode: '755'
  notify: "{{ notify_handlers | default(omit) }}"

- name: Create directories
  ansible.builtin.file:
    path: "{{ target | default(root) }}/{{ item.path }}"
    state: directory
    mode: '755'
  when: item.state == 'directory'
  with_community.general.filetree: "{{ directory }}"
  loop_control:
    label: "{{ item.path }}"
  notify: "{{ notify_handlers | default(omit) }}"

- name: Copy non-template files (no restart, prefix nr_)
  ansible.builtin.copy:
    src: "{{ item.src }}"
    dest: "{{ target | default(root) }}/{{ item.path
                                           | regex_replace('(^|.*/)(nr_)([^/]+)$', '\\1\\3') }}"
    mode: '664'
  when:
    - item.state == 'file'
    - not item.path.endswith('.j2')
    - item.path | basename != '.gitignore'
    - item.path | basename != '.DS_Store'
    - item.path | basename is match('^nr_')
  with_community.general.filetree: "{{ directory }}"
  loop_control:
    label: "{{ item.path }}"

- name: Copy non-template files (with restart)
  ansible.builtin.copy:
    src: "{{ item.src }}"
    dest: "{{ target | default(root) }}/{{ item.path }}"
    mode: '664'
  when:
    - item.state == 'file'
    - not item.path.endswith('.j2')
    - item.path | basename != '.gitignore'
    - item.path | basename != '.DS_Store'
    - not (item.path | basename is match('^nr_'))
  with_community.general.filetree: "{{ directory }}"
  loop_control:
    label: "{{ item.path }}"
  notify: "{{ notify_handlers | default(omit) }}"

- name: Copy template files (no restart, prefix nr_)
  ansible.builtin.template:
    src: "{{ item.src }}"
    dest: "{{ target | default(root) }}/{{ (item.path
                                            | regex_replace('\\.j2$', '')
                                            | regex_replace('(^|.*/)(nr_)([^/]+)$', '\\1\\3')) }}"
    mode: '664'
    lstrip_blocks: true
  when:
    - item.state == 'file'
    - item.path.endswith('.j2')
    - item.path | basename != '.gitignore'
    - item.path | basename != '.DS_Store'
    - item.path | basename is match('^nr_')
  with_community.general.filetree: "{{ directory }}"
  loop_control:
    label: "{{ item.path }}"

- name: Copy template files (with restart)
  ansible.builtin.template:
    src: "{{ item.src }}"
    dest: "{{ target | default(root) }}/{{ item.path | regex_replace('\\.j2$', '') }}"
    mode: '664'
    lstrip_blocks: true
  when:
    - item.state == 'file'
    - item.path.endswith('.j2')
    - item.path | basename != '.gitignore'
    - item.path | basename != '.DS_Store'
    - not (item.path | basename is match('^nr_'))
  with_community.general.filetree: "{{ directory }}"
  loop_control:
    label: "{{ item.path }}"
  notify: "{{ notify_handlers | default(omit) }}"